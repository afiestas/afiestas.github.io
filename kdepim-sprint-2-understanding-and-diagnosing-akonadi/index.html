<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>KDEPIM sprint #2 (Understanding and diagnosing Akonadi)</title>
  <meta name="description" content="In this second part I'm going to explain a few techniques to debug Akonadi we use in order to understand why my KMail installation was working bad.My configu...">
  
  <meta name="author" content="Àlex Fiestas's blog">
  <meta name="copyright" content="&copy; Àlex Fiestas's blog 2023">
  

  <!-- External libraries -->
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/styles/monokai_sublime.min.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightbox2/2.7.1/css/lightbox.css">

  <!-- Favicon and other icons (made with http://www.favicon-generator.org/) -->
  <!--<link rel="shortcut icon" href="/assets/icons/favicon.ico" type="image/x-icon">
	<link rel="icon" href="/assets/icons/favicon.ico" type="image/x-icon">
  <link rel="apple-touch-icon" sizes="57x57" href="/assets/icons/apple-icon-57x57.png">
	<link rel="apple-touch-icon" sizes="60x60" href="/assets/icons/apple-icon-60x60.png">
	<link rel="apple-touch-icon" sizes="72x72" href="/assets/icons/apple-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="76x76" href="/assets/icons/apple-icon-76x76.png">
	<link rel="apple-touch-icon" sizes="114x114" href="/assets/icons/apple-icon-114x114.png">
	<link rel="apple-touch-icon" sizes="120x120" href="/assets/icons/apple-icon-120x120.png">
	<link rel="apple-touch-icon" sizes="144x144" href="/assets/icons/apple-icon-144x144.png">
	<link rel="apple-touch-icon" sizes="152x152" href="/assets/icons/apple-icon-152x152.png">
	<link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/apple-icon-180x180.png">
	<link rel="icon" type="image/png" sizes="192x192"  href="/assets/icons/android-icon-192x192.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="96x96" href="/assets/icons/favicon-96x96.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/assets/icons/favicon-16x16.png">-->
<!-- 	<link rel="manifest" href="/assets/icons/manifest.json"> -->
<!-- 	<meta name="msapplication-TileColor" content="#ffffff"> -->
<!-- 	<meta name="msapplication-TileImage" content="/assets/icons/ms-icon-144x144.png"> -->
	<meta name="theme-color" content="#ffffff">

	<!-- Facebook OGP cards -->
  <meta property="og:description" content="In this second part I'm going to explain a few techniques to debug Akonadi we use in order to understand why my KMail installation was working bad.My configu..." />
  <meta property="og:url" content="http://afiestas.org" />
  <meta property="og:site_name" content="Àlex Fiestas's blog" />
  <meta property="og:title" content="KDEPIM sprint #2 (Understanding and diagnosing Akonadi)" />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="http://afiestas.org/" />
  <meta property="og:image:type" content="" />
  <meta property="og:image:width" content="" />
  <meta property="og:image:height" content="" />

  <!-- Twitter: card tags -->
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="KDEPIM sprint #2 (Understanding and diagnosing Akonadi)">
  <meta name="twitter:description" content="In this second part I'm going to explain a few techniques to debug Akonadi we use in order to understand why my KMail installation was working bad.My configu...">
  <meta name="twitter:image" content="http://afiestas.org/">
  <meta name="twitter:url" content="http://afiestas.org">

  

	<!-- Site styles -->
  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://afiestas.org//kdepim-sprint-2-understanding-and-diagnosing-akonadi/">
  <link rel="alternate" type="application/rss+xml" title="Àlex Fiestas's blog" href="http://afiestas.org//feed.xml" />
</head>


  <body>
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-51319654-1', 'auto');
  ga('send', 'pageview');

</script>

    <header class="navigation" role="banner">
  
</header>


    <div class="page-content">
        <div class="post">

<a href="/">
<div class="post-header-container has-cover" style="background-image: url(/assets/header_image2.jpg);">
	<div class="scrim has-cover">
		<header class="post-header">
		  <h1 class="title">KDEPIM sprint #2 (Understanding and diagnosing Akonadi)</h1>
		  <p class="info">by <strong>Àlex Fiestas</strong></p>
		</header>
	</div>
</div>
</a>
<div class="wrapper">

 <span class="page-divider">
  <span class="one"></span>
  <span class="two"></span>
</span>
 

<section class="post-meta">
	<div class="post-date">November 28, 2012</div>
	<div class="post-categories">
	in 
	  
	  <span>Kde</span>, 
	  
	
	  
	  <span>Software libre</span>
	  
	
	</div>
</section>	

<article class="post-content">
  <p>In this second part I'm going to explain a few techniques to debug Akonadi we use in order to understand why my KMail installation was working bad.</p>
<p><strong>My configuration<br />
</strong>I'm a heavy email user, every day  I receive and read hundreds of them, and I love to have my email synchronized across devices (laptop, workstation, phone, tablet) and particulary in my laptop and workstation I want to have all my email <em>offline</em> so I can make use of it with or without internet, specially useful on my laptop while traveling. Because of all those reasons I have to use something called Disconnect IMAP.</p>
<p><strong>My EMail account<br />
</strong>The account has 5.6GB of data and according to GMail it is split in 700K emails (more or less) 200K of those emails are in a folder (label in GMail) called kde-commits with a size of 1.8GB, then it has 5 folders with more than 25K emails and around 200MB of data each, and finally the rest are just small folders with 500-5000 emails. In total there are 70 folders.</p>
<p><strong>First import experience<br />
</strong>The first problem I have with KMail2 is the experience out of the first email import. Since my account is so huge it takes a while (around 15 hours) to make the full import and I can't use the application while doing it because either the data won't be available or all my CPU power will be used in the task.</p>
<p>To fix this we designed something called "Spanish sync" which basically consist on splitting the task of "Downloading all email while indexing it" into the following steps:</p>
<ol>
<li>Download all the envelopes (subject,from, to, and some other data) starting from the most recent. Once this is done KMail will be fully functional (full email will be downloaded when user tries to read it).</li>
<li>Download in a controlled way all the email bodies (where the content of the email is). Right now this goes as fast as your internet line allows which can be a problem for people having a fast internet connection (100Mb in my case) and slow machine (my laptop is 6yrs old). Once this finishes the email content will be available offline.</li>
<li>Finally we will index all emails. If the user tries to search before this is done we will show an progress indicator.</li>
</ol>
<p>The full synchronization of my email is still going to take 15 hours but I will be able to use my application almost since moment one (since it will import most recent emails first).</p>
<p><strong>KMail not showing email body</strong><br />
Even though I set my account as "Disconnected IMAP", more or less 50% of my emails were not being downloaded so I kept getting this "loading email" message from KMail. This is specially annoying when I'm on my laptop since the internet availability while traveling is not reliable. We have not been able to identify the reason why 1 out 2 emails is not being downloaded but at least I learned how to diagnose this.</p>
<p>Execute the debugging application "akonadiconsole" and go to the "DB console" tab and execute the following SQL query:</p>
<p><!--StartFragment-->SELECT count(*) FROM parttable WHERE name = "PLD:RFC822" AND data is null;</p>
<p><img class="aligncenter" title="Change notification log" src="https://cdn.afiestas.org/posts/2012/11/change-notification.png" alt="" width="399" height="622" /></p>
<p><!--EndFragment--></p>
<p>The result should be a small amount of your total email (in my workstation it is 4K while in my laptop it is 300K). If you set your account as "Disconnected IMAP" and you are getting a high number you may be suffering the same bug.</p>
<p>Unfortunately there is no way to force Akonadi to download the missing body for all those emails... so you will have to either live with it or re-import your account.</p>
<p><strong>KMail not updating email status, not loading anything, not working</strong> !<br />
If all your email is offline and you do not suffer from the bug I mentioned before, you won't even notice this... but if you are using "Normal IMAP" or you suffer the bug this is the most annoying behavior.</p>
<p>Basically all the actions you perform are put in a queue to be processed, for example if you read 100 emails while offline, those "100 read actions" will be stored locally and pushed to the server once online. Where is the problem? the problem is that right now "pushing" this information blocks any other operation to be sure that we are using fresh data so if for instance email XXX is requested akonadi won't provide it until the the "pushing" finishes.</p>
<p>In most IMAP servers pushing this data is FAST, but for some reason in GMail each modification takes around 1/2 seconds... so if I set as read 100 email or I delete 2000 make the math :p</p>
<p>The solution for this is conceptually quite easy, we should only block operations that affect email XXX instead of blocking everything. The technical implementation is a little more difficult than that :p</p>
<p>You can use akonadiconsole to check this "todo list", open it go to "Agents" tab, and in there open the context menu on the agent you want to check and click on "show change-notification log".</p>
<p><a href="https://cdn.afiestas.org/posts/2012/11/emails-without-payload.png"><img class="alignnone" title="Email without payload sql query" src="https://cdn.afiestas.org/posts/2012/11/emails-without-payload-small.png" alt="" width="640" height="371" /></a></p>
<p><strong>Summary:</strong><br />
Akonadi and Kontact2 are an awesome piece of software, I have no doubts that once the issues I mentioned here are fixed we will offer a better user experience than the one you get either in osx or Thunderbird.</p>
<p>As a note, Thunderbird or iMail take also 15 hour to fetch all my email, with the difference that I can use my email right the way, we are not that far.</p>
<p>Finally, a screenshot of how I'd like KMail to look like by default... and I'm not the only one asking this :p</p>
<p><a href="https://cdn.afiestas.org/posts/2012/11/kmail.png"><img class="alignnone" title="KMail awesome config" src="https://cdn.afiestas.org/posts/2012/11/kmail-small.png" alt="" width="640" height="391" /></a></p>
<p>Edit: to have this config just do:</p>
<p>Settings--&gt;Appearance--&gt;Layout--&gt;Show the message preview pane next to the message list<br />
Settings-&gt;Appearance--&gt;Message List--&gt;Default Thene: Fancy with Clickable Status</p>

</article>



<section class="rss">
	<p class="rss-subscribe text"><strong>Subscribe <a href="/feed.xml">via RSS</a></strong></p>
</section>

<section class="share">
  <span>Share: </span>
  
</section>



<section class="disqus">
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    var disqus_shortname = 'afiestas';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>



</div>
</div>

    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h3 class="footer-heading">Àlex Fiestas's blog</h3>

    <div class="site-navigation">
    	
    	<p><strong>Site Map</strong></p>
      <ul class="pages">
        
        
        
        
        
        
        
        
          <li class="nav-link"><a href="/posts/">Posts</a>
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
      </ul>
    </div>

    <div class="site-contact">

    	<p><strong>Contact</strong></p>
      <ul class="social-media-list">
      	<li>
      		<a href="mailto:afiestaso@gmail.com">
	      		<i class="fa fa-envelope-o"></i>
	      		<span class="username">afiestaso@gmail.com</span>
      		</a>
      	</li>

      	

      </ul>
    </div>

    <div class="site-signature">
    	<p class="rss-subscribe text"><strong>Subscribe <a href="/feed.xml">via RSS</a></strong></p>
      <p class="text">Playground for hacking</p>
    </div>

  </div>

</footer>

<!-- Scripts -->
<script src="//code.jquery.com/jquery-1.11.2.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/highlight.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/lightbox2/2.7.1/js/lightbox.min.js"></script>
<script>

$(document).ready(function() {

	// Syntax highlighting
	hljs.initHighlightingOnLoad();

	// Header
  var menuToggle = $('#js-mobile-menu').unbind();
  $('#js-navigation-menu').removeClass("show");
  menuToggle.on('click', function(e) {
    e.preventDefault();
    $('#js-navigation-menu').slideToggle(function(){
      if($('#js-navigation-menu').is(':hidden')) {
        $('#js-navigation-menu').removeAttr('style');
      }
    });
  });


});

</script>




  </body>

</html>
